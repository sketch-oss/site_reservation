<!DOCTYPE html>
<html lang="fr" class="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Configuration - salle de visite LAP</title>
<link rel="stylesheet" href="/assets/app.css">
</head>
<body>
  <div class="app" id="configPage">
  <header class="brand-header">
  <div class="brand-logos">
    <img src="/assets/logo-lap.png" alt="Lien Animaux Patients" class="logo lap">
    <img src="/assets/logo-cpn.png" alt="Centre Psychoth√©rapique de Nancy" class="logo cpn">
  </div>
    <h1>‚öôÔ∏è <span class="accent">Configuration</span> - salle de visite LAP</h1>
    <div>
      <select id="paletteSel"><option value="teal">Teal</option><option value="sage">Sauge</option><option value="sand">Sable</option><option value="slate">Ardoise</option></select>
      <button id="backBtn">‚Ü©Ô∏è Retour</button>
    </div>
  </header>

  <p class="note">Les changements sont appliqu√©s apr√®s avoir enregistr√©.</p>

  <section id="servicesSec">
    <h2>Services</h2>
    <p class="note">Ajouter/supprimer des services.</p>
    <div class="services-grid svc-head">
  <div class="svc-label">Service</div>
  <div class="svc-field">Capacit√©</div>
  <div class="svc-field">Dur√©e (min)</div>
  <div class="svc-field">√âtat</div>
  <div class="svc-trash"></div>
    </div>
    <div id="servicesList" class="service-grid"></div>
    <div class="svc-add">
  <input id="newLabel" placeholder="Libell√© (ex: Sophrologie)"/>
  <input id="newCap" type="number" min="0" value="1" title="Capacit√©"/>
  <select id="newGrey">
    <option value="false">R√©servable</option>
    <option value="true">Colonne gris√©e</option>
  </select>
  <button id="addService">‚ûï</button>
</div>
  </section>

  <section class="card" id="openDaysSec">
  <h2>Jours ouverts</h2>
  <p class="note">D√©coche un jour pour le masquer des plannings (jour ferm√©).</p>
  <div id="openDaysChips" class="chips"></div>
</section>

  <section>
    <h2>Fermetures (p√©riodes)</h2>
    <p class="note">Format <b>jj/mm/aaaa-jj/mm/aaaa</b> (du‚Äìau), une ligne par p√©riode. <i>Ex.</i> 25/12/2025-03/01/2026</p>
    <textarea id="closed" rows="5" placeholder="25/12/2025-03/01/2026"></textarea>
  </section>

  <section>
    <h2>Blocages ponctuels</h2>
    <p class="note">Permet d‚Äôemp√™cher une r√©servation sur un cr√©neau pr√©cis (date + service + heure).</p>
    <div id="blocksList"></div>
    <div style="margin-top:10px">
      <input type="date" id="blockDate">
      <select id="blockService"></select>
      <input type="time" id="blockSlot">
      <button id="addBlock">‚ûï</button>
    </div>
  </section>

  <section>
  <h2>Plannings (Lundi ‚Üí Dimanche)</h2>
  <p class="note">Ajouter des cr√©neaux avec les menus d√©roulants. Possibilit√© d'ajouter ¬´ tous les X min entre A et B ¬ª.</p>
  <div class="planner-toolbar">
  <div class="control">
    <span class="lbl">Plage rapide</span>
    <select id="quickStart"></select>
    <span class="arrow">‚Üí</span>
    <select id="quickEnd"></select>
  </div>

  <div class="control">
    <span>chaque</span>
    <select id="quickStep">
      <option>15</option><option selected>30</option><option>45</option><option>60</option><option>120</option>
    </select>
    <span>min</span>
  </div>

  <div class="control">
    <span class="lbl">Jour</span>
    <select id="qaDay"></select>
  </div>

  <div class="control">
    <select id="quickService" title="Service">
      <option value="*">Tous les services r√©servables</option>
    </select>
  </div>

  <button id="quickApply" class="btn-ghost btn-plus">‚ûï Ajouter</button>

  <span class="hint sub">Astuce : cliquer une carte jour pour la s√©lectionner.</span>
</div>
  <div id="daysWrap" class="card-grid"></div>
</section>


  <section id="mailSec" class="hidden">
  <h2>Emails - R√©glages & mod√®les</h2>
  <p class="note">
    Variables disponibles : <code>{{service}}</code>, <code>{{date}}</code>, <code>{{slot}}</code>, <code>{{email}}</code>
  </p>

  <div class="row" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
    <label>Adresse d'envoi (From)<br>
      <input id="mail_from" type="email" placeholder="resa@cpn-laxou.com">
    </label>
    <label>Destinataire ‚Äúservice bien-√™tre‚Äù<br>
      <input id="mail_responsible" type="email" placeholder="Mathieu.Dreyer@cpn-laxou.com">
    </label>
  </div>

  <h3 style="margin-top:12px">Mod√®les - R√©servation</h3>
  <div class="row" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
    <label>Sujet (client)<br>
      <input id="mail_subject_user" type="text">
    </label>
    <label>Sujet (service)<br>
      <input id="mail_subject_service" type="text">
    </label>
  </div>
  <div class="row" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
    <label>Corps (client)<br>
      <textarea id="mail_body_user" rows="7" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
    </label>
    <label>Corps (service)<br>
      <textarea id="mail_body_service" rows="7" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
    </label>
  </div>

  <h3 style="margin-top:12px">Mod√®les - Annulation</h3>
  <div class="row" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
    <label>Sujet (client)<br>
      <input id="mail_cancel_subject_user" type="text">
    </label>
    <label>Sujet (service)<br>
      <input id="mail_cancel_subject_service" type="text">
    </label>
  </div>
  <div class="row" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">
    <label>Corps (client)<br>
      <textarea id="mail_cancel_body_user" rows="6" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
    </label>
    <label>Corps (service)<br>
      <textarea id="mail_cancel_body_service" rows="6" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
    </label>
  </div>
</section>

  <button id="saveBtn" class="save">üíæ Enregistrer</button>
</div>

<script>
/* ===== Th√®me/palette sync (m√™mes clefs que index) ===== */
function applyPalette(p){document.documentElement.classList.remove('palette-teal','palette-sage','palette-sand','palette-slate');document.documentElement.classList.add(`palette-${p}`,document.documentElement.classList.contains('dark')?'dark':'light');localStorage.setItem('palette',p)}
const toggleTheme=document.getElementById('toggleTheme'), paletteSel=document.getElementById('paletteSel');
applyPalette(localStorage.getItem('palette')||'teal'); paletteSel.value=localStorage.getItem('palette')||'teal';
paletteSel.onchange=e=>applyPalette(e.target.value);
document.getElementById('backBtn').onclick=()=>history.back();

/* ===== API ===== */
const API_BASE=""; const ADMIN_SECRET="INFO0035";

/* ===== jours ===== */
const DAYS=[
  {key:"Monday",label:"Lundi"},{key:"Tuesday",label:"Mardi"},{key:"Wednesday",label:"Mercredi"},
  {key:"Thursday",label:"Jeudi"},{key:"Friday",label:"Vendredi"},{key:"Saturday",label:"Samedi"},{key:"Sunday",label:"Dimanche"},
];
const ALL_DAYS  = DAYS.map(d => d.key);
const DAY_LABEL = Object.fromEntries(DAYS.map(d => [d.key, d.label]));
let OPEN_DAYS   = [...ALL_DAYS];

/* ===== parsing helpers ===== */
// --- helper: un cr√©neau est-il bloqu√© ? ---
// dayIso = "YYYY-MM-DD", serviceKey = "amma" | "rv" | "lumo" | "doin" | "*", timeStr = "HH:MM" ou "HH:MM‚ÄìHH:MM"
function isBlocked(dayIso, serviceKey, timeStr){
  const blocks = (CONFIG && Array.isArray(CONFIG.blocks)) ? CONFIG.blocks : [];
  return blocks.some(b => {
    if (b.date !== dayIso) return false;
    if (!(b.service === "*" || b.service === serviceKey)) return false;
    // match exact "HH:MM" ou plage "HH:MM‚ÄìHH:MM"
    if (b.slot === timeStr) return true;
    // si le bloc est "14:00" et le cr√©neau est "14:00‚Äì15:00", on le consid√®re bloqu√© aussi
    if (/^\d{1,2}:\d{2}$/.test(b.slot) && /^\d{1,2}:\d{2}‚Äì\d{1,2}:\d{2}$/.test(timeStr)) {
      return timeStr.startsWith(b.slot);
    }
    return false;
  });
}

function parseClosedRangesText(text){
  // Convertit "jj/mm/aaaa-jj/mm/aaaa" -> [["YYYY-MM-DD","YYYY-MM-DD"], ...]
  var lines = String(text || "")
    .split(/\r?\n/)
    .map(function(s){ return s.trim(); })
    .filter(Boolean);

  //  function declaration = hoist√©e (pas d‚Äôerreur ‚Äúlexical‚Äù)
  function frToISO(dmy){
    // attend exactement "jj/mm/aaaa"
    var m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(dmy);
    if(!m) throw new Error("Format attendu jj/mm/aaaa");
    var jj = m[1], mm = m[2], aaaa = m[3];
    return aaaa + "-" + mm + "-" + jj; // "YYYY-MM-DD"
  }

  var ranges = [];
  for (var i=0; i<lines.length; i++){
    var line = lines[i];
    var parts = line.split("-");
    if (parts.length !== 2) {
      throw new Error('Ligne invalide: "' + line + '" (attendu jj/mm/aaaa-jj/mm/aaaa)');
    }
    var fromISO = frToISO(parts[0].trim());
    var toISO   = frToISO(parts[1].trim());
    ranges.push([fromISO, toISO]);
  }
  return ranges;
}


function closedRangesToText(closed){
  const toFR = iso => {
    const [y,m,d] = iso.split("-");
    return `${d}/${m}/${y}`;
  };
  return (closed||[])
    .map(([a,b]) => `${toFR(a)}-${toFR(b)}`)
    .join("\n");
}

function saveUI() {                 // ‚úÖ lit l‚Äô√©cran -> met √† jour la copie locale
  try { UI_DAYS = readDaysFromUI(); }
  catch { /* rien, on garde UI_DAYS tel quel */ }
}
function rerender() {               // ‚úÖ re-render √† partir de la copie locale
  renderDaysGrid(UI_DAYS);
}


function parseTimeLines(txt){
  const out=[]; for(let raw of String(txt||"").split(/\r?\n/)){let l=raw.trim(); if(!l||l.startsWith("#")) continue;
    let note=""; const i=l.indexOf("#"); if(i>=0){note=l.slice(i+1).trim(); l=l.slice(0,i).trim()}
    const non=/^!\s*/.test(l)||/\s*!$/.test(l); l=l.replace(/^!\s*/,"").replace(/\s*!$/,"");
    const r=l.match(/^(\d{1,2}:\d{2})\s*[‚Äì-]\s*(\d{1,2}:\d{2})$/); if(r){out.push({t:`${r[1]}‚Äì${r[2]}`,non,note}); continue}
    const s=l.match(/^(\d{1,2}:\d{2})$/); if(s){out.push(non?{t:s[1],non,note}:s[1]);}
  } return out;
}

/* ===== Services UI ===== */
const servicesList=document.getElementById('servicesList');
let CONFIG=null, SERVICES=[];
let UI_DAYS = {};         // ‚úÖ copie locale, seule source pour l‚ÄôUI

function slugify(label){
  return label.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,24);
}
function renderServices(){
  servicesList.innerHTML="";
  SERVICES.forEach((s,idx)=>{
    const row=document.createElement('div'); row.className="service";
row.innerHTML = `
  <div class="svc-label">
    <b>${s.label}</b>
    <small class="note">${s.key}</small>
  </div>

  <div class="svc-field">
    <input type="number" min="0" value="${s.capacity}" data-cap="${idx}" aria-label="Capacit√©">
  </div>

  <div class="svc-field">
    <input type="number" min="5" value="${s.durationMin||30}" data-dur="${idx}" aria-label="Dur√©e (min)">
  </div>

  <div class="svc-field">
    <select data-grey="${idx}" aria-label="√âtat">
      <option value="false"${!s.grey?" selected":""}>R√©servable</option>
      <option value="true"${s.grey?" selected":""}>Colonne gris√©e</option>
    </select>
  </div>

  <div class="svc-trash">
    <button data-del="${idx}" title="Supprimer">üóëÔ∏è</button>
  </div>
`;

    servicesList.appendChild(row);
  });
  servicesList.querySelectorAll("[data-cap]").forEach(el=>{
    el.oninput=()=>{ const i=+el.getAttribute("data-cap"); SERVICES[i].capacity=Math.max(0,+el.value||0); };
  });
  servicesList.querySelectorAll("[data-dur]").forEach(el=>{
  el.oninput=()=>{ const i=+el.getAttribute("data-dur"); SERVICES[i].durationMin=Math.max(5,+el.value||30); };
});

  servicesList.querySelectorAll("[data-grey]").forEach(el=>{
    el.onchange=()=>{ const i=+el.getAttribute("data-grey"); SERVICES[i].grey=el.value==="true"; };
  });
  servicesList.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=()=>{ const i=+btn.getAttribute("data-del");
      SERVICES.splice(i,1); 
renderServices();
rerender();   // ‚úÖ

    };
  });
}
document.getElementById("addService").onclick=()=>{
  const label=(document.getElementById("newLabel").value||"").trim();
  const cap=Math.max(0,+document.getElementById("newCap").value||0);
  const grey=document.getElementById("newGrey").value==="true";
  if(!label){ alert("Libell√© requis."); return; }
  let key=slugify(label)||`srv-${Date.now().toString(36)}`;
  if (SERVICES.some(s=>s.key===key)) key = `${key}-${(Math.random()*100|0)}`;
  SERVICES.push({key,label,capacity:cap,grey});
  document.getElementById("newLabel").value=""; document.getElementById("newCap").value=1; document.getElementById("newGrey").value="false";
  renderServices();
  rerender();   // ‚úÖ affiche depuis UI_DAYS

};

/* ===== Days grid ===== */
const daysWrap = document.getElementById("daysWrap");
const DAYS_ALL = [
  {key:"Monday",label:"Lundi"},{key:"Tuesday",label:"Mardi"},{key:"Wednesday",label:"Mercredi"},
  {key:"Thursday",label:"Jeudi"},{key:"Friday",label:"Vendredi"},{key:"Saturday",label:"Samedi"},{key:"Sunday",label:"Dimanche"},
];

// g√©n√®re des options HH:MM de 08:00 √† 19:00 (tu peux ajuster)
function buildTimeOptions(step=15, start="08:00", end="19:00"){
  const toMin = s=>{const [H,M]=s.split(":").map(Number); return H*60+M;}
  const toHHMM = m=>String(m/60|0).padStart(2,"0")+":"+String(m%60).padStart(2,"0");
  const out=[];
  for(let t=toMin(start); t<=toMin(end); t+=step) out.push(toHHMM(t));
  return out;
}
const TIME_OPTS = buildTimeOptions(15);

// helpers de (d√©)serialization => m√™me format que ton back: "HH:MM" ou "HH:MM‚ÄìHH:MM"
const joinRange = (a,b)=> a===b ? a : `${a}‚Äì${b}`;
function toLines(arr){ return (arr||[]).map(x=>typeof x==="string"?x:(x.non?`! ${x.t}`:x.t)).join("\n"); }

// fabrique un chip visuel
function makeChip(text, onRemove){
  const el=document.createElement("span");
  el.className="slot-chip";
  el.innerHTML=`<b>${text}</b> <span class="x">‚úï</span>`;
  el.querySelector(".x").onclick=onRemove;
  return el;
}

function renderDaysGrid(seedDays){
  daysWrap.innerHTML = "";
  const daysConfig  = seedDays || (CONFIG?.days || {});
  const visibleDays = (OPEN_DAYS.length ? OPEN_DAYS : ALL_DAYS);

  visibleDays.forEach(dayKey => {
    const d = { key: dayKey, label: DAY_LABEL[dayKey] || dayKey };

    const card = document.createElement("div");
    card.dataset.day = d.key; // Monday / Tuesday / ...
    card.className = "day-card";
    card.tabIndex = 0;
    card.addEventListener("click", () => {
  const sel = document.getElementById("qaDay");
  if (sel) sel.value = d.key;          // sync le select
  highlightSelectedDay(d.key);         // applique l‚Äôeffet
});



    // bloc outils + liste par service
    const rows = SERVICES.map(s=>{
      const id = `${d.key}-${s.key}`;
      const slotList = document.createElement("div");
      slotList.className = "slot-list";
      slotList.id = `list-${id}`;

      const startSel = document.createElement("select");
      const endSel   = document.createElement("select");
      TIME_OPTS.forEach(t=>{
        startSel.add(new Option(t,t));
        endSel.add(new Option(t,t));
      });

      const dur = s.durationMin || 30;
      startSel.onchange = ()=>{
        const [H,M]=startSel.value.split(":").map(Number);
        const dt=new Date(2000,0,1,H,M,0);
        dt.setMinutes(dt.getMinutes()+dur);
        const hh=String(dt.getHours()).padStart(2,"0");
        const mm=String(dt.getMinutes()).padStart(2,"0");
        endSel.value = `${hh}:${mm}`;
      };
      startSel.value = "11:30"; startSel.onchange();

      const addBtn = document.createElement("button");
      addBtn.textContent = "‚ûï Ajouter";
      addBtn.onclick = ()=>{
        const a=startSel.value, b=endSel.value;
        const text = joinRange(a,b);
        const store = card._store[id] || (card._store[id]=[]);
        if (!store.some(x => (x.t||x)===text)) {
          store.push(text);
          refreshList(id, slotList, store);
          saveUI();
        }
      };

      const tools = document.createElement("div");
      tools.className="slot-tools";
      tools.innerHTML = `<label>${s.label} ${s.grey?'<span class="tag">gris√©</span>':''}</label>`;
      tools.appendChild(startSel);
      tools.appendChild(document.createTextNode("‚Üí"));
      tools.appendChild(endSel);
      tools.appendChild(addBtn);

      const wrap = document.createElement("div");
      wrap.appendChild(tools);
      wrap.appendChild(slotList);

      const seed = (daysConfig[d.key]?.[s.key]) || [];
      card._store = card._store || {};
      card._store[id] = JSON.parse(JSON.stringify(seed));
      refreshList(id, slotList, card._store[id]);

      return wrap;
    });

    card.innerHTML = `<p class="day-title">${d.label}</p>`;
    rows.forEach(r=>card.appendChild(r));
    daysWrap.appendChild(card);
  });

  const first = daysWrap.querySelector(".day-card");
  if (first) first.classList.add("active");
  highlightSelectedDay(); // s√©lectionne la carte correspondant au select

}


// rafra√Æchit l‚Äôaffichage des chips pour un service d‚Äôun jour
function refreshList(id, listEl, store){
  listEl.innerHTML="";
  (store||[]).forEach((it,idx)=>{
    const text = (typeof it==="string") ? it : ("! "+it.t);
    listEl.appendChild(
      makeChip(text, ()=>{
        store.splice(idx,1);
        refreshList(id, listEl, store);
      })
    );
  });
}

// lit les slots depuis l‚ÄôUI (store embarqu√© sur chaque carte)
function readDaysFromUI(){
  const out = {};
  daysWrap.querySelectorAll(".day-card").forEach(card=>{
    const dayKey = card.dataset.day;   // ‚úÖ Monday / Tuesday / ...
    if (!dayKey) return;
    const obj = {};
    SERVICES.forEach(s=>{
      const id = `${dayKey}-${s.key}`;
      obj[s.key] = (card._store && card._store[id]) ? card._store[id] : [];
    });
    out[dayKey] = obj;
  });
  return out;
}

// === garde l'√©tat courant de l'UI comme seed pour re-render ===
function getSeedDays(){
  try {
    return readDaysFromUI();        // ce qu'il y a √† l'√©cran (chchips)
  } catch {
    return CONFIG?.days || {};      // fallback
  }
}

// remplir les quick selects
(function initQuick(){
  const start = document.getElementById("quickStart");
  const end   = document.getElementById("quickEnd");
  const step  = document.getElementById("quickStep");
  const svcSel= document.getElementById("quickService");
  const qaDaySel = document.getElementById("qaDay");
if (qaDaySel) {
  qaDaySel.addEventListener("change", () => highlightSelectedDay());
}


  // options d‚Äôhoraires
  TIME_OPTS.forEach(t=>{ start.add(new Option(t,t)); end.add(new Option(t,t)); });
  start.value="11:00"; end.value="15:00";

  document.getElementById("quickApply").onclick = ()=>{
    const dayKey = qaDaySel.value || OPEN_DAYS[0] || ALL_DAYS[0];
    const card = [...daysWrap.querySelectorAll(".day-card")].find(c => c.dataset.day === dayKey);
    if (!card) { alert("Aucune carte pour ce jour."); return; }

    const a = start.value, b = end.value, n = +step.value || 30;

    const toMin=s=>{const[H,M]=s.split(":").map(Number);return H*60+M};
    const toHHMM=m=>String((m/60|0)).padStart(2,"0")+":"+String(m%60).padStart(2,"0");
    const A=toMin(a), B=toMin(b);

    const targetServices = (svcSel && svcSel.value && svcSel.value !== "*")
      ? SERVICES.filter(s=>s.key===svcSel.value)
      : SERVICES.filter(s=>!s.grey);

    card._store = card._store || {};
    targetServices.forEach(s=>{
      const id = `${dayKey}-${s.key}`;
      const store = (card._store[id] ||= []);
      for(let t=A; t<=B; t+=n){
        const startHH = toHHMM(t);
        // fin = start + dur√©e du service
        const d = new Date(2000,0,1, ...startHH.split(":").map(Number));
        d.setMinutes(d.getMinutes() + (s.durationMin || 30));
        const endHH = toHHMM(d.getHours()*60 + d.getMinutes());
        const text = (startHH===endHH) ? startHH : `${startHH}‚Äì${endHH}`;
        if (!store.some(x => (x.t||x)===text)) store.push(text);
      }
    });
	  saveUI();       // ‚úÖ met √† jour UI_DAYS avec ce que tu viens d‚Äôajouter
rerender();     // ‚úÖ r√©affiche depuis la copie locale
daysWrap.querySelectorAll(".day-card").forEach(c=>{
  if (c.dataset.day === dayKey) c.classList.add("active");
});
  };
})();
const blocksList=document.getElementById("blocksList");

function renderBlocks(){
  blocksList.innerHTML="";
  (CONFIG.blocks||[]).forEach((b,idx)=>{
    const row=document.createElement("div"); row.className="service";
    const svc=SERVICES.find(s=>s.key===b.service);
    row.innerHTML=`
      <div><b>${b.date}</b> -${svc?svc.label:b.service} - ${b.slot}</div>
      <button data-delblock="${idx}" title="Supprimer">üóëÔ∏è</button>
    `;
    blocksList.appendChild(row);
  });
  blocksList.querySelectorAll("[data-delblock]").forEach(btn=>{
    btn.onclick=()=>{ CONFIG.blocks.splice(+btn.getAttribute("data-delblock"),1); renderBlocks(); };
  });
}

document.getElementById("addBlock").onclick=()=>{
  const date=document.getElementById("blockDate").value;
  const service=document.getElementById("blockService").value;
  const slot=document.getElementById("blockSlot").value;
  if(!date||!slot){ alert("Date et heure requises"); return; }
  CONFIG.blocks=CONFIG.blocks||[];
  CONFIG.blocks.push({date,service,slot});
  renderBlocks();
};

// remplir select services

function fillQuickServices(){
  const sel = document.getElementById("quickService");
  if (!sel) return;
  sel.innerHTML = `<option value="*">Tous les services r√©servables</option>` +
    SERVICES.map(s => `<option value="${s.key}">${s.label}${s.grey?' (gris√©)':''}</option>`).join("");
}

function fillBlockServices(){
  const sel=document.getElementById("blockService");
  sel.innerHTML=`<option value="*">Tous services</option>`+
    SERVICES.map(s=>`<option value="${s.key}">${s.label}</option>`).join("");
}

function fillMailForm(mail){
  const m = mail || {};
  document.getElementById('mail_from').value = m.from || '';
  document.getElementById('mail_responsible').value = m.responsible || '';

  document.getElementById('mail_subject_user').value = m.subject_user || '';
  document.getElementById('mail_body_user').value = m.body_user || '';

  document.getElementById('mail_subject_service').value = m.subject_service || '';
  document.getElementById('mail_body_service').value = m.body_service || '';

  document.getElementById('mail_cancel_subject_user').value = m.cancel_subject_user || '';
  document.getElementById('mail_cancel_body_user').value = m.cancel_body_user || '';

  document.getElementById('mail_cancel_subject_service').value = m.cancel_subject_service || '';
  document.getElementById('mail_cancel_body_service').value = m.cancel_body_service || '';
}

function readMailForm(){
  return {
    from: document.getElementById('mail_from').value.trim(),
    responsible: document.getElementById('mail_responsible').value.trim(),

    subject_user: document.getElementById('mail_subject_user').value,
    body_user: document.getElementById('mail_body_user').value,

    subject_service: document.getElementById('mail_subject_service').value,
    body_service: document.getElementById('mail_body_service').value,

    cancel_subject_user: document.getElementById('mail_cancel_subject_user').value,
    cancel_body_user: document.getElementById('mail_cancel_body_user').value,

    cancel_subject_service: document.getElementById('mail_cancel_subject_service').value,
    cancel_body_service: document.getElementById('mail_cancel_body_service').value,
  };
}

/* ===== Collecte + Save ===== */

function collectConfig(){
  const closed = parseClosedRangesText(document.getElementById("closed").value);
  const days = readDaysFromUI();

  return {
    services: SERVICES,
    closed,
    days,
    blocks: CONFIG.blocks || [],
    openDays: OPEN_DAYS && OPEN_DAYS.length ? OPEN_DAYS.slice() : ALL_DAYS.slice(),
    ...(window.IS_SUPER ? { mail: readMailForm() } : {})
  };
}
document.getElementById("saveBtn").onclick=async()=>{
  const cfg=collectConfig();
  try{
    const r=await fetch(`${API_BASE}/api/config`,{
      method:"PUT",
      headers:{ "Content-Type":"application/json","X-Admin-Secret":ADMIN_SECRET },
      body: JSON.stringify(cfg)
    });
    if(!r.ok) throw 0;
    alert("‚úÖ Configuration enregistr√©e.");
    CONFIG=cfg;
  }catch{ alert("‚ùå Erreur d‚Äôenregistrement."); }
};

/* ===== Init ===== */

async function whoAmI(){
  try{
    const r = await fetch("/api/me", { cache:"no-store" });
    if (!r.ok) return { admin:false, super:false }; // <- d√©faut propre si 404/401/etc.
    const data = await r.json();
    // adapte si ton API renvoie une autre forme
    return { admin: !!data.admin, super: !!data.super };
  }catch{
    return { admin:false, super:false };
  }
}

function renderOpenDays() {
  const wrap = document.getElementById("openDaysChips");
  wrap.innerHTML = "";
  ALL_DAYS.forEach(key => {
    const on = OPEN_DAYS.includes(key);
    const btn = document.createElement("button");
    btn.className = "chip " + (on ? "chip-on" : "chip-off");
    btn.type = "button";
    btn.setAttribute("aria-pressed", on ? "true" : "false");
    btn.textContent = DAY_LABEL[key] || key;

    btn.onclick = () => {
      if (OPEN_DAYS.includes(key)) {
        OPEN_DAYS = OPEN_DAYS.filter(k => k !== key);
      } else {
        OPEN_DAYS = [...OPEN_DAYS, key];
      }
      // garder l‚Äôordre canonique
      OPEN_DAYS = ALL_DAYS.filter(k => OPEN_DAYS.includes(k));
      renderOpenDays();
      fillQaDay();        // MAJ du select ‚ÄúJour‚Äù de la plage rapide
      rerender();         // MAJ cartes jour (masque les ferm√©s)
    };

    wrap.appendChild(btn);
  });
}

// remplit le select "Jour :" au-dessus du bouton ‚ûï
function fillQaDay() {
  const sel = document.getElementById("qaDay");
  sel.innerHTML = "";
  OPEN_DAYS.forEach(k => sel.add(new Option(DAY_LABEL[k] || k, k)));
  // si rien de coch√©, on laisse tous pour √©viter une UI ‚Äúmorte‚Äù
  if (!sel.options.length) ALL_DAYS.forEach(k => sel.add(new Option(DAY_LABEL[k] || k, k)));
  highlightSelectedDay();
}

// petit fallback pour CSS.escape sur vieux navigateurs
if (!window.CSS || !CSS.escape) {
  window.CSS = window.CSS || {};
  CSS.escape = s => String(s).replace(/[^a-zA-Z0-9_-]/g, ch => "\\" + ch);
}

function highlightSelectedDay(forceKey) {
  const key = forceKey || (document.getElementById("qaDay")?.value);
  // on nettoie toutes les cartes
  document.querySelectorAll(".day-card").forEach(c =>
    c.classList.remove("active", "active-select", "is-selected")
  );
  const card = document.querySelector(`.day-card[data-day="${CSS.escape(key)}"]`);
  if (!card) return;

  // si un re-render arrive juste apr√®s, rejoue une frame plus tard
  card.classList.add("is-selected");
  requestAnimationFrame(() => {
    // protection suppl√©mentaire si le DOM a boug√©
    const again = document.querySelector(`.day-card[data-day="${CSS.escape(key)}"]`);
    if (again) again.classList.add("is-selected");
  });
}
// √âcouteur automatique
document.getElementById("qaDay").addEventListener("change", highlightSelectedDay);

	
(async function(){
  const r=await fetch(`${API_BASE}/api/config`); if(!r.ok) return alert("Erreur chargement config");
  CONFIG=await r.json();
  OPEN_DAYS = Array.isArray(CONFIG.openDays) && CONFIG.openDays.length
  ? ALL_DAYS.filter(k => CONFIG.openDays.includes(k)) // ordre canonique
  : [...ALL_DAYS];

renderOpenDays();
fillQaDay();
  const me = await whoAmI();
window.IS_SUPER = !!me.super;

const mailSec = document.getElementById("mailSec");
  mailSec.classList.add("hidden");
  if (Array.isArray(CONFIG.services)) {
    SERVICES = JSON.parse(JSON.stringify(CONFIG.services));
  } else {
    const L=CONFIG.labels||{amma:"Massage AMMA Assis",rv:"R√©alit√© Virtuelle",lumo:"Luminoth√©rapie",doin:"Do In"};
    const C=CONFIG.capacities||{amma:1,rv:1,lumo:2};
    SERVICES=[
      {key:"amma",label:L.amma,capacity:C.amma??1,grey:false},
      {key:"rv",  label:L.rv,  capacity:C.rv??1,  grey:false},
      {key:"lumo",label:L.lumo,capacity:C.lumo??2,grey:false},
      {key:"doin",label:L.doin,capacity:0,grey:true}
    ];
  }
  document.getElementById("closed").value = closedRangesToText(CONFIG.closed||[]);
UI_DAYS = JSON.parse(JSON.stringify(CONFIG.days || {}));   // ‚úÖ deep clone
document.getElementById("closed").value = closedRangesToText(CONFIG.closed || []);
renderServices();
renderDaysGrid(UI_DAYS);                                    // üîÅ passe la copie locale
fillQuickServices();
fillBlockServices();
renderBlocks();
})();
</script>
</body>
</html>

